<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bus Tracker — Viewer + Uplink</title>

<!-- Simple debugging console (remove if not needed) -->
<script src="https://cdn.jsdelivr.net/npm/eruda"></script>
<script>eruda.init();</script>

<style>
  :root{--bar:56px}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font:15px system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#f6f7f9}
  header{position:sticky;top:0;background:#fff;display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:10px 12px;border-bottom:1px solid #e5e7eb;z-index:5}
  h1{margin:0;font-size:16px;font-weight:600}
  .sp{flex:1}
  .badge{padding:4px 8px;border-radius:999px;background:#eef;border:1px solid #cfd3ff;font-size:12px}
  .badge.ok{background:#e8f7ee;border-color:#bde7cd}
  .badge.err{background:#fff0f0;border-color:#ffc8c8}
  .tabs button{border:1px solid #ddd;background:#fff;border-radius:8px;padding:8px 12px}
  .tabs button.active{background:#111;color:#fff;border-color:#111}
  main{height:calc(100% - var(--bar))}
  section.tab{display:none;height:100%}
  section.tab.active{display:block}
  /* viewer */
  #map{width:100%;height:100%}
  #legend{position:absolute;top:12px;left:12px;background:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.12);padding:10px 12px;font-size:14px;z-index:2}
  #legend b{display:block;margin-bottom:6px}
  .row{display:flex;align-items:center;gap:8px;margin:4px 0}
  .dot{width:12px;height:12px;border-radius:50%}
  /* uplink */
  .wrap{padding:16px}
  .line{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  input,button{font:inherit;padding:10px 12px;border-radius:10px;border:1px solid #ddd;background:#fff}
  button.primary{background:#111;color:#fff;border-color:#111}
  button.ghost{background:#fff}
  #status{margin-left:8px;color:#667}
  #log{margin-top:14px;white-space:pre-wrap;background:#fff;border:1px solid #eee;border-radius:10px;padding:10px;max-height:40vh;overflow:auto}
</style>

<!-- Firebase compat (app + auth + firestore) -->
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
</head>
<body>
<header>
  <h1>Bus Tracker</h1>
  <span id="authBadge" class="badge">Auth: …</span>
  <span id="mapsBadge" class="badge">Maps: …</span>
  <button id="btnTestWrite" class="badge">Test Write</button>
  <div class="sp"></div>
  <div class="tabs">
    <button id="tabViewer" class="active">Viewer</button>
    <button id="tabUplink">Uplink</button>
  </div>
</header>

<main>
  <!-- Viewer -->
  <section id="viewer" class="tab active">
    <div id="legend">
      <b>Live buses</b>
      <div class="row"><span class="dot" style="background:#e11d48"></span> bus1 (red)</div>
      <div class="row"><span class="dot" style="background:#059669"></span> bus2 (green)</div>
      <div class="row" style="color:#667"><small>Dim after 30s without update</small></div>
    </div>
    <div id="map"></div>
  </section>

  <!-- Uplink -->
  <section id="uplink" class="tab">
    <div class="wrap">
      <div class="line">
        <label>Bus ID:
          <input id="busId" value="bus1" />
        </label>
        <button id="btnStart" class="primary">Start</button>
        <button id="btnStop"  class="ghost">Stop</button>
        <span id="status">Idle</span>
      </div>
      <div id="log"></div>
      <p style="color:#667;margin-top:10px">
        Note: keep this page in the foreground for continuous GPS. For true background tracking, use the Expo native app we prepared.
      </p>
    </div>
  </section>
</main>

<script>
// --- your Firebase config ---
const FB = {
  apiKey: "AIzaSyAxYIfdEJfBACJ8GLAAzPkHDmZQBGiWmSk",
  authDomain: "bus-tracker-9f330.firebaseapp.com",
  projectId: "bus-tracker-9f330",
  storageBucket: "bus-tracker-9f330.firebasestorage.app",
  messagingSenderId: "233973447994",
  appId: "1:233973447994:web:ace69cb031d4a429166403"
};
const MAPS_KEY = "AIzaSyBBCZp-x1J3v69m2DUmKMo-gBaQymxeAbk";

// initialize Firebase
firebase.initializeApp(FB);
const db = firebase.firestore();
const auth = firebase.auth();

// helper for badges
const authBadge = document.getElementById('authBadge');
function setAuthBadge(text, ok) {
  authBadge.textContent = 'Auth: ' + text;
  authBadge.className = 'badge ' + (ok ? 'ok' : (ok === false ? 'err' : ''));
}
const mapsBadge = document.getElementById('mapsBadge');
function setMapsBadge(text, ok) {
  mapsBadge.textContent = 'Maps: ' + text;
  mapsBadge.className = 'badge ' + (ok ? 'ok' : (ok === false ? 'err' : ''));
}

// sign in anonymously
setAuthBadge('signing in…');
auth.signInAnonymously().then(() => {
  setAuthBadge('anonymous OK', true);
}).catch((e) => {
  console.warn(e);
  setAuthBadge('error', false);
});

// Tabs logic
const vBtn = document.getElementById('tabViewer');
const uBtn = document.getElementById('tabUplink');
const vSec = document.getElementById('viewer');
const uSec = document.getElementById('uplink');
vBtn.onclick = () => switchTab('viewer');
uBtn.onclick = () => switchTab('uplink');
function switchTab(which) {
  const isViewer = which === 'viewer';
  vSec.classList.toggle('active', isViewer);
  uSec.classList.toggle('active', !isViewer);
  vBtn.classList.toggle('active', isViewer);
  uBtn.classList.toggle('active', !isViewer);
  if (isViewer) ensureMaps();
}

// Maps & viewer logic
let map, markers = new Map(), mapsLoaded = false;
function ensureMaps() {
  if (mapsLoaded) {
    google.maps.event.trigger(map, 'resize');
    return;
  }
  setMapsBadge('loading…');
  const s = document.createElement('script');
  s.src = `https://maps.googleapis.com/maps/api/js?key=${MAPS_KEY}&callback=initMap`;
  s.async = true; s.defer = true;
  s.onerror = () => setMapsBadge('load failed', false);
  document.head.appendChild(s);
  window.initMap = () => {
    setMapsBadge('loaded', true);
    initMap();
  };
  mapsLoaded = true;
}
function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: 52.6549, lng: -7.2523},
    zoom: 13
  });
  // subscribe to bus updates
  db.collection('buses').onSnapshot((snap) => {
    const seen = new Set();
    snap.forEach((doc) => {
      const id = doc.id;
      const d = doc.data() || {};
      if (typeof d.lat !== 'number' || typeof d.lng !== 'number') return;
      upsertMarker(id, d);
      seen.add(id);
    });
    // remove markers for deleted buses
    markers.forEach((m, id) => {
      if (!seen.has(id)) {
        m.setMap(null);
        markers.delete(id);
      }
    });
  }, (err) => {
    console.warn('viewer onSnapshot error:', err);
  });
}
function upsertMarker(id, d) {
  const pos = {lat: d.lat, lng: d.lng};
  const color = id === 'bus1' ? '#e11d48' : '#059669';
  const stale = isStale(d.updatedAt);
  let m = markers.get(id);
  const icon = busIcon(color);
  if (!m) {
    m = new google.maps.Marker({map, position: pos, title: id, icon});
    markers.set(id, m);
  } else {
    m.setPosition(pos);
    m.setIcon(icon);
  }
  m.setOpacity(stale ? 0.55 : 1);
}
function isStale(updatedAt) {
  const t = updatedAt && updatedAt.toDate ? updatedAt.toDate() :
            (updatedAt ? new Date(updatedAt) : null);
  return t ? (Date.now() - t.getTime() > 30000) : true;
}
function busIcon(color) {
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 40">
    <rect x="2" y="6" width="60" height="22" rx="4" fill="${color}"/>
    <rect x="6" y="10" width="34" height="8" rx="2" fill="#fff"/>
    <rect x="44" y="10" width="14" height="8" rx="2" fill="#fff"/>
    <circle cx="18" cy="34" r="4" fill="#111"/>
    <circle cx="46" cy="34" r="4" fill="#111"/>
  </svg>`;
  return {
    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg),
    scaledSize: new google.maps.Size(44, 28),
    anchor: new google.maps.Point(22, 14)
  };
}

// Uplink logic
const busInput = document.getElementById('busId');
const startBtn = document.getElementById('btnStart');
const stopBtn = document.getElementById('btnStop');
const statusEl = document.getElementById('status');
const logEl = document.getElementById('log');
let watchId = null, wakeLock = null;

function log(t) { logEl.textContent = `${new Date().toLocaleTimeString()} — ${t}\n` + logEl.textContent; }
function setStatus(t) { statusEl.textContent = t; }

startBtn.onclick = startStream;
stopBtn.onclick  = stopStream;

async function startStream() {
  const id = (busInput.value || 'bus1').trim();
  if (!navigator.geolocation) { log('Geolocation not supported'); return; }
  // keep screen awake on supporting browsers
  try {
    if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen');
  } catch {}
  setStatus('Streaming as ' + id);
  startBtn.disabled = true;
  stopBtn.disabled = false;
  const docRef = db.collection('buses').doc(id);
  watchId = navigator.geolocation.watchPosition(
    async pos => {
      const {latitude: lat, longitude: lng, heading, speed} = pos.coords;
      try {
        await docRef.set({
          lat, lng,
          heading: Number.isFinite(heading) ? heading : null,
          speed:   Number.isFinite(speed)   ? speed   : null,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, {merge: true});
        log(`sent ${id}: ${lat.toFixed(5)}, ${lng.toFixed(5)}`);
      } catch (e) {
        log('write error: ' + e.message);
      }
    },
    err => { log('GPS error: ' + err.message); },
    {enableHighAccuracy: true, maximumAge: 2000, timeout: 10000}
  );
}
async function stopStream() {
  if (watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; }
  if (wakeLock) { try { await wakeLock.release(); } catch {} wakeLock = null; }
  startBtn.disabled = false;
  stopBtn.disabled = true;
  setStatus('Stopped');
  log('stopped');
}

// Test write button (helps confirm rules)
document.getElementById('btnTestWrite').onclick = async () => {
  try {
    await db.collection('buses').doc('_debug').set(
      { ping: firebase.firestore.FieldValue.serverTimestamp() },
      { merge: true }
    );
    log('TEST WRITE OK (/buses/_debug)');
  } catch (e) {
    log('TEST WRITE ERROR: ' + e.message);
  }
};

// default to viewer (loads maps)
ensureMaps();

</script>
<!-- End of combined viewer+uplink HTML -->
</body>
</html>
